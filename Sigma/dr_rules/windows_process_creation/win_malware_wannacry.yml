detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \tasksche.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \mssecsvc.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \taskdl.exe
      - case sensitive: false
        op: contains
        path: event/FILE_PATH
        value: \@WanaDecryptor@
      - case sensitive: false
        op: contains
        path: event/FILE_PATH
        value: \WanaDecryptor
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \taskhsvc.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \taskse.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \111.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \lhdfrgui.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \diskpart.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \linuxnew.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \wannacry.exe
    - op: or
      rules:
      - case sensitive: false
        op: matches
        path: event/COMMAND_LINE
        value: .*icacls .* /grant Everyone:F /T /C /Q.*
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: bcdedit /set {default} recoveryenabled no
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: wbadmin delete catalog -quiet
      - case sensitive: false
        op: contains
        path: event/COMMAND_LINE
        value: '@Please_Read_Me@.txt'
respond:
- action: report
  metatdata:
    author: Florian Roth (rule), Tom U. @c_APT_ure (collection)
    description: Detects WannaCry ransomware activity
    level: critical
    references:
    - https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100
  name: WannaCry Ransomware

