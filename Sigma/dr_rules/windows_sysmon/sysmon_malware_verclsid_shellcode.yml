detect:
  log type: wel
  op: and
  rules:
  - op: and
    rules:
    - case sensitive: false
      op: is
      path: Event/System/EventID
      value: '10'
    - case sensitive: false
      op: ends with
      path: Event/EventData/TargetImage
      value: \verclsid.exe
    - case sensitive: false
      op: is
      path: Event/EventData/GrantedAccess
      value: '0x1FFFFF'
  - op: or
    rules:
    - case sensitive: false
      op: matches
      path: Event/EventData/CallTrace
      re: .*\|UNKNOWN\(.*VBE7\.DLL.*
    - op: and
      rules:
      - case sensitive: false
        op: contains
        path: Event/EventData/SourceImage
        value: \Microsoft Office\
      - case sensitive: false
        op: contains
        path: Event/EventData/CallTrace
        value: '|UNKNOWN'
  target: log
respond:
- action: report
  metadata:
    author: John Lambert (tech), Florian Roth (rule)
    description: Detects a process access to verclsid.exe that injects shellcode from
      a Microsoft Office application / VBA macro
    level: high
    references:
    - https://twitter.com/JohnLaTwC/status/837743453039534080
    tags:
    - attack.defense_evasion
    - attack.privilege_escalation
    - attack.t1055
  name: Malware Shellcode in Verclsid Target Process

