detect:
  log type: wel
  op: and
  rules:
  - op: and
    rules:
    - case sensitive: false
      op: is
      path: Event/System/EventID
      value: '3'
    - case sensitive: false
      op: is
      path: Event/EventData/Initiated
      value: 'true'
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4443'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '2448'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '8143'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1777'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1443'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '243'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '65535'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13506'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '3360'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '200'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '198'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '49180'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13507'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '6625'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4444'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4438'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1904'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13505'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13504'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '12102'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '9631'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '5445'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '2443'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '777'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13394'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '13145'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '12103'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '5552'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '3939'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '3675'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '666'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '473'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '5649'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4455'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4433'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1817'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '100'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '65520'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1960'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '1515'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '743'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '700'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '14154'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '14103'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '14102'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '12322'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '10101'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '7210'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '4040'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationPort
        value: '9943'
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: contains
      path: Event/EventData/Image
      value: \Program Files
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: '10.'
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 192.168.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.16.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.17.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.18.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.19.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.20.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.21.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.22.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.23.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.24.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.25.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.26.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.27.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.28.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.29.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.30.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: 172.31.
        - case sensitive: false
          op: starts with
          path: Event/EventData/DestinationIp
          value: '127.'
      - case sensitive: false
        op: is
        path: Event/EventData/DestinationIsIpv6
        value: 'false'
  target: log
respond:
- action: report
  metadata:
    author: Florian Roth
    description: Detects programs that connect to typical malware back connect ports
      based on statistical analysis from two different sandbox system databases
    level: medium
    references:
    - https://docs.google.com/spreadsheets/d/17pSTDNpa0sf6pHeRhusvWG6rThciE8CsXTSlDUAZDyo
    tags:
    - attack.command_and_control
    - attack.t1043
  name: Suspicious Typical Malware Back Connect Ports

